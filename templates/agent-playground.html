{% extends "base-html.html" %}

{% block title %}{{ contentData.title }}{% endblock %}

{% block javascript %}
<link rel="stylesheet" href="{{ url_for('static', filename='agent-playground/workspace.css') }}" />
<script type="module" src="{{ url_for('static', filename='agent-playground/workspace.js') }}"></script>
{% endblock %}

{% block leftPanel %}
<div id="left-panel" class="panel-section-left">
    <div class="panel-header">
        <nav onclick="panelMan.togglePanel('left');">
            <svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g id="Edit / Add_Minus_Square">
                    <path id="Vector" d="M8 12H16M4 16.8002V7.2002C4 6.08009 4 5.51962 4.21799 5.0918C4.40973 4.71547 4.71547 4.40973 5.0918 4.21799C5.51962 4 6.08009 4 7.2002 4H16.8002C17.9203 4 18.4801 4 18.9079 4.21799C19.2842 4.40973 19.5905 4.71547 19.7822 5.0918C20.0002 5.51962 20.0002 6.07967 20.0002 7.19978V16.7998C20.0002 17.9199 20.0002 18.48 19.7822 18.9078C19.5905 19.2841 19.2842 19.5905 18.9079 19.7822C18.4805 20 17.9215 20 16.8036 20H7.19691C6.07899 20 5.5192 20 5.0918 19.7822C4.71547 19.5905 4.40973 19.2842 4.21799 18.9079C4 18.4801 4 17.9203 4 16.8002Z" stroke="var(--accent-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </g>
            </svg>
        </nav>
        <div class="section-auxiliary">
            <h3>Playground Controls</h3>
        </div>
    </div>
    <div class="panel-content ap-side-layout">
        <section class="ap-side-card">
            <h4>Workspace Sections</h4>
            <ul id="ap-side-sections" class="ap-side-list">
                {% for section in contentData.sections %}
                <li>{{ section }}</li>
                {% endfor %}
            </ul>
        </section>

        <section class="ap-side-card">
            <h4>Requested Model</h4>
            <p class="ap-side-muted">Type a model name or choose from discovered Ollama models.</p>
            <div class="ap-model-requested-row">
                <input id="ap-model-requested-input" type="text" placeholder="qwen3-vl:latest" autocomplete="off" />
                <select id="ap-model-requested-select">
                    <option value="">Loading models...</option>
                </select>
            </div>
            <p id="ap-model-source-hint" class="ap-side-muted">Model inventory pending...</p>
        </section>

        <section class="ap-side-card">
            <h4>Run Hotkeys</h4>
            <ul class="ap-side-list">
                <li><code>Ctrl/Cmd + Enter</code> starts a run.</li>
                <li>Use pane toggles to focus trace/state/artifacts.</li>
                <li>Select a trace step to inspect exact payloads.</li>
            </ul>
        </section>
    </div>
    <div class="panel-footer button-bar">
        <div class="button-text">Run Setup</div>
    </div>
</div>
{% endblock %}

{% block content %}
<div id="ap-workspace" data-api-base="/api/agent-playground">
    <section id="ap-toolbar">
        <div class="ap-toolbar-group">
            <label for="ap-run-mode">Run Mode</label>
            <select id="ap-run-mode"></select>
            <label for="ap-run-history">Run History</label>
            <select id="ap-run-history"></select>
            <button id="ap-start-btn" type="button">Start Run</button>
            <button id="ap-refresh-btn" type="button">Refresh</button>
        </div>
        <div class="ap-toolbar-group" id="ap-pane-controls">
            <span class="ap-toolbar-label">Panes</span>
        </div>
        <div class="ap-toolbar-group">
            <label for="ap-layout-preset">Layout</label>
            <select id="ap-layout-preset">
                <option value="balanced">Balanced</option>
                <option value="chat_focus">Chat Focus</option>
                <option value="analysis_focus">Analysis Focus</option>
            </select>
            <button id="ap-layout-reset" type="button">Reset Panes</button>
        </div>
        <div class="ap-toolbar-group">
            <span id="ap-run-status">Idle</span>
            <span id="ap-run-meta">Run: <span id="ap-run-id">-</span></span>
            <span id="ap-run-mode-meta">Mode: <span id="ap-run-mode-active">-</span></span>
        </div>
        <div class="ap-toolbar-group" id="ap-metrics-row">
            <span class="ap-metric-chip">Total <strong id="ap-metric-total">0</strong></span>
            <span class="ap-metric-chip">Running <strong id="ap-metric-running">0</strong></span>
            <span class="ap-metric-chip">Avg(s) <strong id="ap-metric-avg">0</strong></span>
            <span class="ap-metric-chip">Completed <strong id="ap-metric-completed">0</strong></span>
            <span class="ap-metric-chip">Failed <strong id="ap-metric-failed">0</strong></span>
        </div>
    </section>

    <section class="ap-pane" id="ap-schema-pane">
        <header class="ap-pane-header">
            <div class="ap-pane-title">Schema Driven Config</div>
            <div class="ap-pane-header-actions">
                <button class="ap-pane-collapse-btn" type="button" data-pane-collapse="schema" aria-expanded="true">Collapse</button>
            </div>
        </header>
        <div class="ap-pane-body">
            <div class="ap-toolbar-group">
                <label for="ap-schema-capability">Capability</label>
                <select id="ap-schema-capability"></select>
            </div>
            <form id="ap-schema-form"></form>
        </div>
    </section>

    <section id="ap-grid">
        <article class="ap-pane" id="ap-chat-pane">
            <header class="ap-pane-header">
                <div class="ap-pane-title">Chat / Run</div>
                <div class="ap-pane-header-actions">
                    <button class="ap-pane-collapse-btn" type="button" data-pane-collapse="chat" aria-expanded="true">Collapse</button>
                </div>
            </header>
            <div class="ap-pane-body" data-pane="chat"></div>
        </article>

        <article class="ap-pane" id="ap-trace-pane">
            <header class="ap-pane-header">
                <div class="ap-pane-title">Trace / Steps</div>
                <div class="ap-pane-header-actions">
                    <button class="ap-pane-collapse-btn" type="button" data-pane-collapse="trace" aria-expanded="true">Collapse</button>
                </div>
            </header>
            <div class="ap-pane-body" data-pane="trace"></div>
        </article>

        <article class="ap-pane" id="ap-state-pane">
            <header class="ap-pane-header">
                <div class="ap-pane-title">State</div>
                <div class="ap-pane-header-actions">
                    <button class="ap-pane-collapse-btn" type="button" data-pane-collapse="state" aria-expanded="true">Collapse</button>
                </div>
            </header>
            <div class="ap-pane-body" data-pane="state"></div>
        </article>

        <article class="ap-pane" id="ap-artifacts-pane">
            <header class="ap-pane-header">
                <div class="ap-pane-title">Artifacts</div>
                <div class="ap-pane-header-actions">
                    <button class="ap-pane-collapse-btn" type="button" data-pane-collapse="artifacts" aria-expanded="true">Collapse</button>
                </div>
            </header>
            <div class="ap-pane-body" data-pane="artifacts"></div>
        </article>

        <article class="ap-pane" id="ap-inspector-pane">
            <header class="ap-pane-header">
                <div class="ap-pane-title">Inspector</div>
                <div class="ap-pane-header-actions">
                    <button class="ap-pane-collapse-btn" type="button" data-pane-collapse="inspector" aria-expanded="true">Collapse</button>
                </div>
            </header>
            <div class="ap-pane-body" data-pane="inspector"></div>
        </article>
    </section>
</div>
{% endblock %}

{% block rightTopPanel %}
<div id="right-top-panel">
    <div class="panel-header">
        <div class="section-auxiliary">
            <h3>Active Run Snapshot</h3>
        </div>
        <nav onclick="panelMan.togglePanel('right');">
            <svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g id="Edit / Add_Minus_Square">
                    <path id="Vector" d="M8 12H16M4 16.8002V7.2002C4 6.08009 4 5.51962 4.21799 5.0918C4.40973 4.71547 4.71547 4.40973 5.0918 4.21799C5.51962 4 6.08009 4 7.2002 4H16.8002C17.9203 4 18.4801 4 18.9079 4.21799C19.2842 4.40973 19.5905 4.71547 19.7822 5.0918C20.0002 5.51962 20.0002 6.07967 20.0002 7.19978V16.7998C20.0002 17.9199 20.0002 18.48 19.7822 18.9078C19.5905 19.2841 19.2842 19.5905 18.9079 19.7822C18.4805 20 17.9215 20 16.8036 20H7.19691C6.07899 20 5.5192 20 5.0918 19.7822C4.71547 19.5905 4.40973 19.2842 4.21799 18.9079C4 18.4801 4 17.9203 4 16.8002Z" stroke="var(--accent-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </g>
            </svg>
        </nav>
    </div>
    <div class="panel-content ap-side-layout">
        <div class="ap-side-stat-grid">
            <span class="ap-side-key">Run ID</span><span id="ap-side-run-id" class="ap-side-value">-</span>
            <span class="ap-side-key">Status</span><span id="ap-side-run-status" class="ap-side-value">idle</span>
            <span class="ap-side-key">Mode</span><span id="ap-side-run-mode" class="ap-side-value">-</span>
            <span class="ap-side-key">Model</span><span id="ap-side-run-model" class="ap-side-value">router default</span>
            <span class="ap-side-key">Events</span><span id="ap-side-run-events" class="ap-side-value">0</span>
        </div>
        <p class="ap-side-muted">Updates in real time from the append-only run stream.</p>
    </div>
    <div class="panel-footer button-bar">
        <div class="button-text">Run Metadata</div>
    </div>
</div>
{% endblock %}

{% block rightBottomPanel %}
<div id="right-bottom-panel">
    <div class="panel-header">
        <div class="section-auxiliary">
            <h3>Selected Step</h3>
        </div>
    </div>
    <div class="panel-content ap-side-layout">
        <div class="ap-side-stat-grid">
            <span class="ap-side-key">Sequence</span><span id="ap-side-event-seq" class="ap-side-value">-</span>
            <span class="ap-side-key">Event Type</span><span id="ap-side-event-type" class="ap-side-value">-</span>
            <span class="ap-side-key">Stage</span><span id="ap-side-event-stage" class="ap-side-value">-</span>
            <span class="ap-side-key">Status</span><span id="ap-side-event-status" class="ap-side-value">-</span>
        </div>
        <pre id="ap-side-event-summary" class="ap-side-json">Select a trace row to inspect payload details.</pre>
    </div>
    <div class="panel-footer button-bar">
        <div class="button-text">Trace Inspector</div>
    </div>
</div>
{% endblock %}

{% block footer %}
<div id="ap-composer">
    <div id="ap-mode-helper" class="ap-mode-helper">Chat mode: Ask one question and run.</div>
    <textarea id="ap-input" placeholder="Enter a user prompt. For batch mode, add one input per line. For workflow mode, define stage intent in natural language."></textarea>
    <div id="ap-composer-actions">
        <button id="ap-run-btn" type="button">Run</button>
        <button id="ap-cancel-btn" type="button">Cancel</button>
        <button id="ap-replay-btn" type="button">Replay</button>
        <button id="ap-resume-btn" type="button">Resume</button>
    </div>
</div>
{% endblock %}
