{% extends "base-html.html" %}

{% block title %}{{ contentData.title }}{% endblock %}

{% block javascript %}
<script>
(function() {
    // ========================
    // Utility Module
    // ========================
    const Utils = {
        jsonToFormData: function(json) {
            console.log("Utils: Starting jsonToFormData conversion", json);
            const fd = new FormData();
            for (const key in json) {
                if (json.hasOwnProperty(key)) {
                    fd.append(key, json[key]);
                    console.log(`Utils: Appended key: ${key} with value: ${json[key]}`);
                }
            }
            console.log("Utils: Finished FormData conversion", fd);
            return fd;
        }
    };

    // ========================
    // Tag Manager Module
    // ========================
    const TagManager = {
        updateTagsButtons: function(tagsString) {
            console.log("TagManager: Updating tags with string:", tagsString);
            const tagsContainer = document.getElementById('knowledgeTags');
            if (!tagsContainer) {
                console.warn("TagManager: 'knowledgeTags' element not found.");
                return;
            }
            tagsContainer.innerHTML = '';
            if (tagsString) {
                const tagsArray = tagsString.split(',')
                    .map(tag => tag.trim())
                    .filter(tag => tag.length > 0);
                tagsArray.forEach(tag => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.textContent = tag;
                    btn.classList.add('tag-btn', 'active');
                    btn.addEventListener('click', function () {
                        console.log(`TagManager: Toggling tag button for tag "${tag}"`);
                        btn.classList.toggle('active');
                    });
                    tagsContainer.appendChild(btn);
                    console.log(`TagManager: Added tag button for "${tag}"`);
                });
            }
        }
    };

    // ========================
    // Knowledge Handler Module
    // ========================
    const KnowledgeHandler = (function() {
        let lastClickedKnowledgeItem = null;
        return {
            handleItemClick: function(item) {
                console.log("KnowledgeHandler: Item clicked", item);
                const knowledgeContent = item.querySelector('.list-item-body').textContent.trim();
                const tagsElement = item.querySelector('.list-item-categories');
                const knowledgeTags = tagsElement ? tagsElement.textContent.trim() : '';
                
                if (lastClickedKnowledgeItem === item) {
                    console.log("KnowledgeHandler: Same item clicked again. Toggling 'right' panel.");
                    panelMan.togglePanel('right');
                    lastClickedKnowledgeItem = null;
                } else {
                    console.log("KnowledgeHandler: New item clicked. Updating editor content.");
                    document.getElementById('knowledgeDataEditor').value = knowledgeContent;
                    TagManager.updateTagsButtons(knowledgeTags);
                    lastClickedKnowledgeItem = item;
                    if (!panelMan.panelStates['right']) {
                        console.log("KnowledgeHandler: 'right' panel is hidden. Showing panel.");
                        panelMan.showPanel('right');
                    }
                }
            },
            resetLastClicked: function() {
                console.log("KnowledgeHandler: Resetting last clicked knowledge item.");
                lastClickedKnowledgeItem = null;
            }
        };
    })();

    // ========================
    // Editor Module
    // ========================
    const Editor = {
        clearFields: function() {
            console.log("Editor: Clearing all editor fields.");
            document.getElementById('knowledgeDataEditor').value = '';
            document.getElementById('knowledgeTagInput').value = '';
            document.getElementById('knowledgeTitleInput').value = '';
            document.getElementById('knowledgeDescriptionInput').value = '';
            document.getElementById('knowledgeAuthorInput').value = '';
            document.getElementById('knowledgeSourceInput').value = '';
            document.getElementById('knowledgeLinkInput').value = '';
            document.getElementById('knowledgeTags').innerHTML = '';
            document.getElementById('selectedDomains').innerHTML = '';
            document.getElementById('selectedRoles').innerHTML = '';
        },
        setFooterButtonForAdd: function() {
            const footerButton = document.querySelector('#right-top-panel .button-text');
            if (footerButton) {
                footerButton.textContent = 'Add Entry';
                footerButton.onclick = Editor.submitNewKnowledgeItem;
                console.log("Editor: Footer button configured for 'Add Entry'.");
            } else {
                console.warn("Editor: Footer button not found.");
            }
        },
        submitNewKnowledgeItem: function() {
            console.log("Editor: Submitting new knowledge item.");
            const knowledgeContent = document.getElementById('knowledgeDataEditor').value.trim();
            if (!knowledgeContent) {
                alert("Knowledge Entry content is required!");
                console.warn("Editor: Knowledge content is missing. Aborting submission.");
                return;
            }
            const packet = {
                knowledge_document: knowledgeContent
            };
            const titleInput = document.getElementById('knowledgeTitleInput').value.trim();
            if (titleInput) {
                packet.title = titleInput;
                console.log("Editor: Added title to packet:", titleInput);
            }
            const descriptionInput = document.getElementById('knowledgeDescriptionInput').value.trim();
            if (descriptionInput) {
                packet.description = descriptionInput;
                console.log("Editor: Added description to packet:", descriptionInput);
            }
            const authorInput = document.getElementById('knowledgeAuthorInput').value.trim();
            if (authorInput) {
                packet.author = authorInput;
                console.log("Editor: Added author to packet:", authorInput);
            }
            const sourceInput = document.getElementById('knowledgeSourceInput').value.trim();
            if (sourceInput) {
                packet.source = sourceInput;
                console.log("Editor: Added source to packet:", sourceInput);
            }
            const linkInput = document.getElementById('knowledgeLinkInput').value.trim();
            if (linkInput) {
                packet.link = linkInput;
                console.log("Editor: Added link to packet:", linkInput);
            }
            // Gather selected domains
            const selectedDomains = Array.from(document.getElementById('selectedDomains').children)
                .map(btn => btn.textContent);
            if (selectedDomains.length > 0) {
                packet.domains = selectedDomains;
                console.log("Editor: Selected domains:", selectedDomains);
            }
            // Gather selected roles
            const selectedRoles = Array.from(document.getElementById('selectedRoles').children)
                .map(btn => btn.textContent);
            if (selectedRoles.length > 0) {
                packet.roles = selectedRoles;
                console.log("Editor: Selected roles:", selectedRoles);
            }
            // Gather active tag buttons as categories
            const activeTagButtons = Array.from(document.querySelectorAll('#knowledgeTags .tag-btn.active'))
                .map(btn => btn.textContent);
            if (activeTagButtons.length > 0) {
                packet.categories = activeTagButtons;
                console.log("Editor: Active tag buttons (categories):", activeTagButtons);
            }

            console.log("Editor: Final packet before FormData conversion:", packet);

            const documentMetadata = {
                "source": packet.source || "",
                "title": packet.title || "",
                "author": packet.author || "",
                "link": packet.link || "",
                "description": packet.description || "",
            };

            // Prepare FormData packet.
            const fd = new FormData();
            fd.append('knowledge_document', knowledgeContent);
            // Append additional fields from the main window.
            if (packet.domains) {
                fd.append('domains', JSON.stringify(packet.domains));
                console.log("Editor: Appended domains:", packet.domains);
            }
            if (packet.roles) {
                fd.append('roles', JSON.stringify(packet.roles));
                console.log("Editor: Appended roles:", packet.roles);
            }
            if (packet.categories) {
                fd.append('categories', JSON.stringify(packet.categories));
                console.log("Editor: Appended categories:", packet.categories);
            }
            fd.append("document_metadata", JSON.stringify(documentMetadata));

            console.log("Editor: Final FormData entries:");
            fd.forEach((value, key) => {
                console.log(`Editor: FormData key: ${key}, value: ${value}`);
            });

            const req = new Request("/knowledge/add", {
                method: 'POST',
                body: fd
            });
            console.log("Editor: Sending POST request to '/knowledge/add' with FormData");
            fetch(req)
                .then(response => response.json())
                .then(data => {
                    console.log("Editor: Submission successful. Server responded with:", data);
                })
                .catch(error => {
                    console.error("Editor: Error during submission:", error);
                    alert("Error:\n" + error);
                });
        },
        launchAddEntryMode: function() {
            console.log("Editor: Launching Add Entry mode.");
            Editor.clearFields();
            Editor.setFooterButtonForAdd();
            KnowledgeHandler.resetLastClicked();
            if (!panelMan.panelStates['right']) {
                console.log("Editor: 'right' panel is not visible. Displaying panel.");
                panelMan.showPanel('right');
            }
        }
    };

    // ========================
    // Dropdown Manager Module
    // ========================
    const DropdownManager = {
        populateDropdown: function(url, dropdownId) {
            console.log("DropdownManager: Fetching data from", url, "for dropdown", dropdownId);
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const dropdown = document.getElementById(dropdownId);
                    if (dropdown) {
                        data.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item;
                            option.textContent = item;
                            dropdown.appendChild(option);
                            console.log(`DropdownManager: Added option "${item}" to dropdown "${dropdownId}"`);
                        });
                    } else {
                        console.warn(`DropdownManager: Dropdown element with id "${dropdownId}" not found.`);
                    }
                })
                .catch(error => {
                    console.error("DropdownManager: Error fetching dropdown data:", error);
                });
        }
    };

    // ========================
    // Tag Input Manager Module
    // ========================
    const TagInputManager = {
        init: function() {
            console.log("TagInputManager: Initializing tag input.");
            const tagInputField = document.getElementById('knowledgeTagInput');
            if (tagInputField) {
                tagInputField.addEventListener("keydown", function(e) {
                    if (e.key === "Enter") {
                        e.preventDefault();
                        const tagValue = this.value.trim();
                        if (tagValue.length > 0) {
                            const tagsContainer = document.getElementById('knowledgeTags');
                            const exists = Array.from(tagsContainer.children)
                                .some(btn => btn.textContent === tagValue);
                            if (!exists) {
                                const newBtn = document.createElement('button');
                                newBtn.type = 'button';
                                newBtn.textContent = tagValue;
                                newBtn.classList.add('tag-btn', 'active');
                                newBtn.addEventListener('click', function() {
                                    console.log("TagInputManager: Toggling tag button for tag:", tagValue);
                                    newBtn.classList.toggle('active');
                                });
                                tagsContainer.appendChild(newBtn);
                                console.log("TagInputManager: Added new tag button for:", tagValue);
                            } else {
                                console.log("TagInputManager: Tag already exists:", tagValue);
                            }
                        }
                        this.value = '';
                    }
                });
            } else {
                console.warn("TagInputManager: 'knowledgeTagInput' element not found.");
            }
        }
    };

    // ========================
    // Selection Manager Module (Domains & Roles)
    // ========================
    const SelectionManager = {
        init: function() {
            console.log("SelectionManager: Initializing domain and role selection.");
            // Domain addition button
            document.getElementById('addDomainBtn').addEventListener('click', function () {
                const domainDropdown = document.getElementById('domainDropdown');
                const selectedValue = domainDropdown.value;
                if (selectedValue) {
                    const selectedDomainsContainer = document.getElementById('selectedDomains');
                    const exists = Array.from(selectedDomainsContainer.children)
                        .some(child => child.textContent === selectedValue);
                    if (!exists) {
                        const newBtn = document.createElement('button');
                        newBtn.type = 'button';
                        newBtn.textContent = selectedValue;
                        newBtn.classList.add('selected-domain-btn');
                        newBtn.addEventListener('click', () => {
                            console.log("SelectionManager: Removing domain button for:", selectedValue);
                            selectedDomainsContainer.removeChild(newBtn);
                        });
                        selectedDomainsContainer.appendChild(newBtn);
                        console.log("SelectionManager: Added domain:", selectedValue);
                    } else {
                        console.log("SelectionManager: Domain already selected:", selectedValue);
                    }
                }
            });
            // Role addition button
            document.getElementById('addRoleBtn').addEventListener('click', function () {
                const roleDropdown = document.getElementById('roleDropdown');
                const selectedValue = roleDropdown.value;
                const selectedRolesContainer = document.getElementById('selectedRoles');
                if (selectedValue) {
                    const exists = Array.from(selectedRolesContainer.children)
                        .some(child => child.textContent === selectedValue);
                    if (!exists) {
                        const newBtn = document.createElement('button');
                        newBtn.type = 'button';
                        newBtn.textContent = selectedValue;
                        newBtn.classList.add('selected-role-btn');
                        newBtn.addEventListener('click', () => {
                            console.log("SelectionManager: Removing role button for:", selectedValue);
                            selectedRolesContainer.removeChild(newBtn);
                        });
                        selectedRolesContainer.appendChild(newBtn);
                        console.log("SelectionManager: Added role:", selectedValue);
                    } else {
                        console.log("SelectionManager: Role already selected:", selectedValue);
                    }
                }
            });
        }
    };

    // ========================
    // Global Delete Function
    // ========================
    // This function sends a POST to the new /knowledge/delete endpoint with the knowledge_id.
    window.deleteKnowledge = function(knowledgeId) {
        if (!confirm("Are you sure you want to delete the knowledge entry with ID: " + knowledgeId + "?")) {
            return;
        }
        const fd = new FormData();
        fd.append("knowledge_id", knowledgeId);
        console.log("deleteKnowledge: Sending deletion request for knowledge ID:", knowledgeId);

        fetch("/knowledge/delete", {
            method: "POST",
            body: fd
        })
        .then(response => response.json())
        .then(data => {
            console.log("deleteKnowledge: Server responded with:", data);
            if (data.success) {
                // Remove the deleted entry from the DOM.
                const entry = document.querySelector(`[data-knowledge-id="${knowledgeId}"]`);
                if (entry) {
                    entry.remove();
                    console.log("deleteKnowledge: Removed entry for knowledge ID:", knowledgeId);
                }
            } else {
                alert("Failed to delete entry: " + data.error);
            }
        })
        .catch(error => {
            console.error("deleteKnowledge: Error during deletion:", error);
            alert("Error deleting entry: " + error);
        });
    };

    // ========================
    // Initialization on DOMContentLoaded
    // ========================
    document.addEventListener('DOMContentLoaded', function () {
        console.log("DOM fully loaded. Initializing components.");
        DropdownManager.populateDropdown('/knowledge/domains-list', 'domainDropdown');
        DropdownManager.populateDropdown('/knowledge/roles-list', 'roleDropdown');
        TagInputManager.init();
        SelectionManager.init();
        console.log("All components initialized.");
    });

    // Expose functions for HTML event handlers
    window.knowledgeItemClicked = KnowledgeHandler.handleItemClick;
    window.addKnowledgeItem = Editor.launchAddEntryMode;
    window.jsonToFormData = Utils.jsonToFormData;
})();
</script>
{% endblock %}

{% block leftPanel %}
<style>
    .panel-auto { height: calc(15% - var(--micro-rem)) !important; }
    .panel-fill { height: 85% !important; }
    .detatched-button-bar {
        text-align: center;
        vertical-align: middle;
        line-height: var(--panel-bar-height);
        left: 0;
        top: 0;
        font-weight: bold;
        cursor: pointer;
        position: absolute;
        box-sizing: border-box;
        height: 100%;
        width: 100%;
        line-height: calc(var(--panel-bar-height) - (2 * var(--micro-rem)));
    }
    .primary-editor{
        display:flex;
        flex-flow:column;
    }
    .primary-editor label{
        margin-top: var(--mini-rem);
    }
    .detatched-button-bar:hover {
        background-color: var(--accent-primary);
        color: var(--accent-dark);
    }
    .detatched-button-bar:hover .button-text {
        color: var(--accent-dark);
    }
</style>
<div id="left-panel" class="panel-section-left panel-no-footer">
    <div class="panel-header">
        <nav onclick="panelMan.togglePanel('left');">
            <svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g id="Edit / Add_Minus_Square">
                    <path id="Vector" d="M8 12H16M4 16.8002V7.2002C4 6.08009 4 5.51962 4.21799 5.0918C4.40973 4.71547 4.71547 4.40973 5.0918 4.21799C5.51962 4 6.08009 4 7.2002 4H16.8002C17.9203 4 18.4801 4 18.9079 4.21799C19.2842 4.40973 19.5905 4.71547 19.7822 5.0918C20.0002 5.51962 20.0002 6.07967 20.0002 7.19978V16.7998C20 17.9199 20 18.48 19.7822 18.9078C19.5905 19.2841 19.2842 19.5905 18.9079 19.7822C18.4805 20 17.9215 20 16.8036 20H7.19691C6.07899 20 5.5192 20 5.0918 19.7822C4.71547 19.5905 4.40973 19.2842 4.21799 18.9079C4 18.4801 4 17.9203 4 16.8002Z" stroke="var(--accent-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </g>
            </svg>
        </nav>
        {% if contentData.sections %}
        <div class="section-auxiliary">
            <select>
                {% for section in contentData.sections %}
                <option>{{ section }}</option>
                {% endfor %}
            </select>
        </div>
        {% else %}
        <div id="section-title">
            <h3>{{ contentData.title }}</h3>
        </div>
        {% endif %}
    </div>
    <div class="panel-content">
        <p>Knowledge</p>
        <p>Sort</p>
        <p>Panel</p>
    </div>
    <div class="panel-footer footer-detached"></div>
</div>
{% endblock %}

{% block content %}
{% for knowledge in knowledgeData %}
<div class="list-item-container" data-knowledge-id="{{ knowledge['knowledge_id'] }}" onclick="knowledgeItemClicked(this);">
    <div class="list-item-header">
        <h3>{{ knowledge["knowledge_id"] }}</h3>
        <!-- Delete button added next to the ID -->
        <button type="button" class="delete-btn"  onclick="deleteKnowledge(knowledgeId={{ knowledge['knowledge_id'] }});">
            Delete
        </button>
    </div>
    <div class="list-item-body">
        {{ knowledge["knowledge_document"] }}
    </div>
    <div class="list-item-footer">
        {% if knowledge["categories"] %}
        <div class="list-item-categories">
            {{ ', '.join(knowledge["categories"]) }}
        </div>
        {% endif %}
    </div>
</div>
{% endfor %}
{% endblock %}

{% block rightTopPanel %}
<div id="right-top-panel" class="panel-fill">
    <div class="panel-header">
        <nav onclick="panelMan.togglePanel('right');">
            <svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <!-- SVG Icon -->
            </svg>
        </nav>
        <div class="section-auxiliary">
            <h3>Knowledge Editor</h3>
        </div>
    </div>
    <div class="panel-content">
        <!-- Domain Selection Section -->
        <div class="domain-section">
            <label for="domainDropdown">Domains:</label>
            <select id="domainDropdown">
                <option value="">Select Domain</option>
            </select>
            <button type="button" id="addDomainBtn">+ Add Domain</button>
            <div id="selectedDomains" style="display: flex; gap: 0.5rem;"></div>
        </div>
        <!-- Roles Selection Section -->
        <div class="role-section">
            <label for="roleDropdown">Roles:</label>
            <select id="roleDropdown">
                <option value="">Select Role</option>
            </select>
            <button type="button" id="addRoleBtn">+ Add Role</button>
            <div id="selectedRoles" style="display: flex; gap: 0.5rem;"></div>
        </div>
        <!-- Primary Editor and Additional Fields -->
        <div class="primary-editor">
            <label for="knowledgeData">Knowledge Entry Editor</label>
            <textarea name="knowledgeData" id="knowledgeDataEditor"></textarea>
            <label for="knowledgeTag">Knowledge Tags</label>
            <input type="text" name="knowledgeTag" id="knowledgeTagInput">
            <div id="knowledgeTags"></div>
            <label for="knowledgeTitle">Title</label>
            <input type="text" name="knowledgeTitle" id="knowledgeTitleInput">
            <label for="knowledgeDescription">Description</label>
            <input type="text" name="knowledgeDescription" id="knowledgeDescriptionInput">
            <label for="knowledgeAuthor">Author</label>
            <input type="text" name="knowledgeAuthor" id="knowledgeAuthorInput">
            <label for="knowledgeSource">Source</label>
            <input type="text" name="knowledgeSource" id="knowledgeSourceInput">
            <label for="knowledgeLink">Link</label>
            <input type="text" name="knowledgeLink" id="knowledgeLinkInput">
        </div>
    </div>
    <div class="panel-footer button-bar">
        <div class="button-text">Save Edit</div>
    </div>
</div>
{% endblock %}

{% block rightBottomPanel %}
<div id="right-bottom-panel" class="panel-auto panel-no-footer panel-no-header">
    <div class="panel-header"></div>
    <div class="panel-content">
        <b>Knowledge Tools</b> - all the Knowledge display we want in the <i>bottom</i> panel
    </div>
    <div class="panel-footer"></div>
</div>
{% endblock %}

{% block footer %}
<div class="detatched-button-bar" onclick="addKnowledgeItem();">
    <div class="button-text">Add Knowledge</div>
</div>
{% endblock %}
